---

- hosts: all
  # pre_tasks for installing dependencies for running the tests within docker
  pre_tasks:
    - include_vars: "vars/{{ ansible_os_family }}.yml"
    - get_url:
        url: "{{ test_nodejs_url }}"
        dest: /tmp/setup_nodejs
        mode: "0777"
    - command: /tmp/setup_nodejs
    - action: "{{ ansible_pkg_mgr }} pkg=nodejs state=present"
    - file:
        path: /run/lock/subsys
        state: directory
  roles:
    - weareinteractive.pm2
  vars:
    pm2_apps:
      - run: apps.json
        path: "/etc/ansible/roles/weareinteractive.pm2/tests"
      - run: console_error.js
        args: --name console_error
        path: "/etc/ansible/roles/weareinteractive.pm2/tests/apps"
        env:
          NODE_ENV: dev
    pm2_service_name: "{{ test_pm2_service_name }}"
    pm2_startup: "{{ test_pm2_startup }}"
